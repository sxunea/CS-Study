# 2.2.1 TCP/IP 4계층 구조

인터넷 프로토콜 스위트는 인터넷에서 컴퓨터들이 서로 정보를 주고 받는데 쓰이는 프로토콜의 집합인데, 이를 **OSI 7계층**이나 **TCP/IP 4계층**으로 표현한다

OSI 7계층은 데이터 통신의 과정을 7개의 계층으로 분류한 모델이고, TCP/IP 4계층은 실제로 사용되는 프로토콜 스택이다

<br>

<img width="543" alt="image" src="https://github.com/sxunea/CS-Study/assets/81434152/c0508643-3b6f-4a75-b02d-afd97502dde0">

## 어플리케이션 계층
어플리케이션 계층은 FTP, HTTP, SSH, SMTP, DNS 등 응용 프로그램이 사용되는 프로토콜 계층이며 **사용자들에게 실질적으로 제공되는 층**이다
```
데이터 단위 : Data / Nessage
```

- **FTP**

    장치와 장치 간의 파일을 전송하는 데 사용되는 표준 통신 프로토콜
- **SSH**

    보안되지 않은 네트워크에서 네트워크 서비스를 안전하게 운영하기 위한 암호화 네트워크 프로토콜
- **HTTP**

    World Wide Web을 위한 데이터 통신의 기초이자 웹 사이트를 이용하는 데 쓰는 프로토콜
- **SMTP**

    전자 메일 전송을 위한 인터넷 표준 통신 프로토콜
- **DNS**

    도메인 이름과 IP 주소를 매핑해주는 서버, 예를 들어 www.naver.com에 DNS 쿼리가 오면 [Root DNS]+ [.com DNS] > [naver DNS] + [:Www DNS] 과정을 거쳐 완벽한 주소를 찾아 IP 주소를 매핑한다. 이 를 통해 IP 주소가 바뀌어도 사용자들에게 똑같은 도메인 주소로 서비스할 수 있다. 예를 들어 www.naver.com의 IP 주소가 222111.222.111에서 222111.222122로 바뀌었음에도 똑같은 www.naver.com이라 는 주소로 서비스가 가능하다

<br>
웹 브라우저에서는 화면에 필요한 데이터를 요청하기 위해 HTTP 데이터를 생성한다. 이러한 HTTP에도 양식이 존재하는데, 이러한 통신약속을 프로토콜이라고 한다


## 전송 계층
전송 계층은 **서비스를 구분하고 데이터의 전송 방식**을 담당한다. 연결 지향 데이터 스트림 지원, 신뢰성, 흐름 제어를 제공할 수 있으며 어플리케이션과 인터넷 계층 사이의 데이터가 전달될 때의 중개 역할을 한다

```
데이터 단위 : Segment
전송 주소 : Port
```

이를 **TCP, UDP 프로토콜**을 통해 통신을 활성화 한다

### TCP
**TCP**(Transmission Control Protocol)는 IP 규칙으로만 통신하기에 부족하거나 불안정하던 여러 단점들(패킷 순서가 이상하거나 패킷이 유실)을 커버해, **패킷 전송을 제어하여 신뢰성을 보증**하는 프로토콜이다

<img width="848" alt="image" src="https://github.com/sxunea/CS-Study/assets/81434152/77343da5-7168-4581-b15e-17fb3c887ee5">

- IP 프로토콜이 단순한 배달 주소가 담긴 포장이라고 한다면, TCP는 오배송을 막기 위한 안전 보장 추가 포장이다

TCP는 패킷 사이의 순서를 보장하고 연결 지향 프로토콜을 사용해서 연결을 해 신뢰성을 구축해 수신 여부를 확인하고, 가상회선 패킷 교환 방식을 사용한다

- **가상 회선 패킷 교환 방식**
    - 각 패킷에 가상회선 식별자가 포함되어 있고, 모든 패킷을 전송하면 가상회선이 해제되고 패킷들은 전송된 순서대로 도착하는 방식

<br>

이러한 TCP는 신뢰성을 확보하기 위해 **통신을 시작할때 3-way handshake, 통신을 마칠때 4-way handshake 과정**을 거친다. 


**TCP 연결 성립 과정 : 3-way handshake**

<img width="531" alt="image" src="https://github.com/sxunea/CS-Study/assets/81434152/6be32770-1237-428a-9dd5-c4e4a7320118">

<br>

다음과 같은 순서를 가진다
- 클라이언트가 서버에 연결 요청 (**SYN**)

    클라이언트는 서버에 연결하고자 SYN(Synchronize) 패킷 송신
    패킷에 클라이언트의 초기 시퀀스 번호(ISN)를 포함한다

- 서버가 클라이언트 요청에 응답 (**SYN-ACK**)

    서버는 클라이언트의 SYN 패킷을 수신하고 클라이언트에 대한 응답으로 SYN-ACK (Synchronize-Acknowledgment) 패킷 송신하는데, 서버의 ISN과 클라이언트의 ISN + 1 을 포함한다

- 클라이언트가 서버에 응답 (**ACK**)

   클라이언트는 서버의 ISN + 1한 값인 승인번호를 담아 ACK를 서버에 보낸다


<br>
<br>

**TCP 연결 해제 과정 : 4-way handshake**

<img width="535" alt="image" src="https://github.com/sxunea/CS-Study/assets/81434152/aeb606d6-2817-414c-b0be-cab189be2173">

<br>
다음과 같은 순서를 가진다

- 클라이언트가 서버에 연결 종료 요청 (**FIN**)

    클라이언트는 서버에 연결을 종료하고자 CLOSE()호출하고 FIN(Finishing) 패킷 송신한다

    클라이언트는 더 이상 데이터를 전송하지 않을 것임을 알리고, FIN_WAIT1 상태가 됨
- 서버가 클라이언트 요청에 응답 (**ACK**)

    서버는 클라이언트의 FIN 패킷 수신
    수신을 확인하기 위해 ACK(Acknowledgment) 패킷 송신한다

    클라이언트는 아직 서버 쪽에서 데이터를 받을 수 있음 따라서 남은거 있으면 이때 나머지를 함께 송신한다
- 서버가 클라이언트에 연결 종료 요청 (**FIN**)

    ACK를 받은 클라이언트는 FIN_WAIT2로 변환되고, 서버는 자신의 데이터 전송이 끝났음을 알리기 위해 CLOSE() 호출하고 FIN패킷을 송신한다
- 클라이언트가 서버 요청에 응답 (**ACK**)

    클라이언트는 서버의 FIN 패킷 수신
    수신을 확인하기 위해 ACK패킷 송신하고, TIME_WAIT 상태로 전환된다

    이 모든 것이 끝나면 CLOSED상태로 변환된다

### UDP
**UDP**(User Datagram Protocol)는 단어에서도 알 수 있듯이 데이터그램 방식을 사용하는 프로토콜이기 때문에 애초에 각각의 패킷 간의 순서가 존재하지 않는 독립적인 패킷을 사용한다. 

TCP는 신뢰성을 확보하기 위한 일련의 과정을 거치기 때문에 어쩔 수 없는 속도의 한계점이 있어 UDP 방식이 등장했고, 따라서 이는 실시간 영상 스트리밍과 같은 고용량 데이터를 다루는 곳에 이용된다

- **데이터그램 패킷 교환 방식**
    - 데이터를 전송하기 전에 논리적 연결이 설정되어 있지 않고, 패킷이 독립적으로 전송된다
    - 패킷의 목적지만 정해져있다면 중간 경로는 어딜 타든 신경쓰지 않기 때문에 핸드쉐이크 과정 같은 연결 설정이 필요 없게된다
    - 순서가 보장되어있지 않고, 비 연결지향형 프로콜이다

### TCP vs UDP

![image](https://github.com/sxunea/CS-Study/assets/81434152/337c4d19-450d-41cb-8bae-273f67ec77e4)


## 인터넷 계층
**장치로부터 받은 네트워크 패킷을 IP 주소로 지정된 목적지로 전송**하기 이해 사용되는 계층이다

IP를 사용하여 **데이터의 원천지와 목적지에 대한 정보를 첨부**해 데이터를 전달한다. 

IP는 복잡한 네트워크 망속에서 가장 효율적인 방법으로 작은 데이터들을 빠르게 보내므로, **패킷 전달 여부를 보증하지 않고** 빠른 송신에 집중한다.

```
데이터 단위 : 패킷
전송 주소 : IP
```

- **IP** 

    비연결의 서비스를 제공하며, 발신지와 목적지까지의 라우팅 경로를 결정
- **ICMP**	

    IP제어와 메시지 기능을 담당
- **ARP**

    IP주소를 이용해 상대방의 MAC주소를 알아오는 프로토콜
    
    - MAC 주소 : 하드웨어 주소
- **RARP**	

    MAC주소에 해당하는 IP주소를 알아오는 프로토콜 

## 링크 계층
링크 계층은 실질적으로 데이터의 전달에 관여하는 계층으로, **물리적으로 데이터가 네트워크를 통해 어떻게 전송**되는지를 정의한다


논리 주소(IP)가 아닌 물리 주소(MAC)를 참조해 장비간에 전송한다.

 최종적으로 데이터 전송을 하기 전 패킷헤더에 MAC 주소와 오류 검출을 위한 부분을 첨부해 핸들링하고, 데이터 패킷을 전기신호로 변환하여 선로를 통해 전달할 수 있게 한다

```
데이터 단위 : 프레임
전송 주소 : MAC
```

<br>

## TCP/IP 4계층의 Protocol Suite

![image](https://github.com/sxunea/CS-Study/assets/81434152/5fc92dbc-359d-4780-a71e-459997925266)

## TCP/IP 4계층의 계층간 데이터 송수신 과정
![image](https://github.com/sxunea/CS-Study/assets/81434152/9ae086cb-1c8c-489c-b5d5-1843756a5f90)

애플리케이션 계층에서 전송계층으로 사용자가 보내는 요청값들이 **캡슐화** 과정을 거쳐 전달되고, 

다시 링크 계층을 통해 해당 서버와 통신을 하고, 

해당 서버의 링크 계층으로부터 애플리케이션까지 **비캡슐화** 과정을 거쳐 데이터가 전송된다

### 캡슐화 
![image](https://github.com/sxunea/CS-Study/assets/81434152/9c554a96-4ddb-4c87-89a0-1a9f2246843d)

![image](https://github.com/sxunea/CS-Study/assets/81434152/3ccb14e8-9bcf-4f1d-90b9-dde999c60551)

**상위 계층의 헤더와 데이터**를 **하위 계층의 데이터 부분**에 포함시키고, **해당 계층의 헤더를 삽입**하는 과정으로 **데이터의 캡슐화**를 진행한다

위의 첨부자료처럼 하위 계층의 데이터가 전달되면서 해당 계층의 헤더가 붙여지게되면서 해당 계층의 **데이터 단위화**가 된다


### 비캡슐화

![image](https://github.com/sxunea/CS-Study/assets/81434152/91a0345e-9d8b-4f46-a8ed-28f767dcfbd0)

하위 계층에서 상위 계층으로 가며 **각 계층의 헤더 부분을 제거하는 과정**으로 **데이터의 비캡슐화**를 진행한다

비캡슐화 과정을 진행하면 최종적으로 사용자에게 어플리케이션의 PDU인 메시지로 전달된다
-   PDU 프로토콜 데이터 단위
    -   데이터 통신에서 상위 계층이 전달한 데이터에 붙이는 제어정보
    - 계층에 따라서 데이터가 
        - 사용자는 Data 
        - TCP는 Segment 
        - IP는 Packet 
        - 데이터링크는 Frame
        - 컴퓨터 하드웨어는 그것을 Bit 로 연산하고 다루게 된다

<br>

![image](https://github.com/sxunea/CS-Study/assets/81434152/b794f39e-f9d6-4dc0-a297-d5cf0d8f9f21)




### 참고

https://docs.oracle.com/cd/E38901_01/html/E38894/ipov-29.html#ipov-32

https://medium.com/@kusal95/tcp-3-way-handshake-process-1fd9a056a2f4

https://velog.io/@hidaehyunlee/TCP-%EC%99%80-UDP-%EC%9D%98-%EC%B0%A8%EC%9D%B4

https://inpa.tistory.com/entry/NW-%F0%9F%8C%90-%EC%95%84%EC%A7%81%EB%8F%84-%EB%AA%A8%ED%98%B8%ED%95%9C-TCP-UDP-%EA%B0%9C%EB%85%90-%E2%9D%93-%EC%89%BD%EA%B2%8C-%EC%9D%B4%ED%95%B4%ED%95%98%EC%9E%90

https://yozm.wishket.com/magazine/detail/1956/